<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module">
  // Импортируйте необходимые функции из SDK Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

  // Конфигурация вашего Firebase проекта
  const firebaseConfig = {
    apiKey: "AIzaSyDXyC1mdhh9xAVbYPWJUuFjWkKzLYKC3Wg",
    authDomain: "maangoff.firebaseapp.com",
    projectId: "maangoff",
    storageBucket: "maangoff.firebasestorage.app",
    messagingSenderId: "32275259475",
    appId: "1:32275259475:web:ca11e0aa78de847132a6a6"
  };

  // Инициализация Firebase
  const app = initializeApp(firebaseConfig);

  // Инициализация Firestore и Storage
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Инициализация авторизации
  const auth = getAuth(app);
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maangoff Portfolio</title>
  <style>
    /* Стили личного кабинета */
    .profile-container {
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .profile-container h2 {
      text-align: center;
    }
    .profile-form input, .profile-form textarea, .profile-form button {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .profile-form img {
      display: block;
      margin: 10px auto;
      max-width: 150px;
      border-radius: 50%;
    }
    .gallery-container {
      margin-top: 20px;
    }
    .gallery-container input {
      margin-bottom: 20px;
    }
    .gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .gallery img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="profilePage" class="profile-container" style="display: none;">
    <h2>My Profile</h2>
    <form id="profileForm" class="profile-form">
      <img id="profileImage" src="" alt="Profile Picture">
      <input type="file" id="profileImageInput" accept="image/*">
      <input type="text" id="nameInput" placeholder="Name">
      <input type="number" id="ageInput" placeholder="Age">
      <textarea id="bioInput" rows="5" placeholder="Biography"></textarea>
      <button type="button" onclick="saveProfile()">Save Profile</button>
    </form>
    <div class="gallery-container">
      <h3>Your Gallery</h3>
      <input type="file" id="galleryInput" accept="image/*" multiple>
      <div class="gallery" id="gallery"></div>
    </div>
  </div>

  <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

    const auth = getAuth();
    const db = getFirestore();
    const storage = getStorage();

    const profilePage = document.getElementById('profilePage');
    const profileForm = document.getElementById('profileForm');
    const profileImage = document.getElementById('profileImage');
    const profileImageInput = document.getElementById('profileImageInput');
    const nameInput = document.getElementById('nameInput');
    const ageInput = document.getElementById('ageInput');
    const bioInput = document.getElementById('bioInput');
    const galleryInput = document.getElementById('galleryInput');
    const gallery = document.getElementById('gallery');

    // Проверка авторизации
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        profilePage.style.display = 'block';
        const userDoc = doc(db, "users", user.uid);
        const docSnap = await getDoc(userDoc);

        if (docSnap.exists()) {
          const data = docSnap.data();
          nameInput.value = data.name || '';
          ageInput.value = data.age || '';
          bioInput.value = data.bio || '';
          if (data.profileImageUrl) profileImage.src = data.profileImageUrl;
          loadGallery(user.uid);
        }
      } else {
        alert('You need to log in!');
        window.location.href = '/'; // Вернуть на главную страницу
      }
    });

    // Сохранение профиля
    async function saveProfile() {
      const user = auth.currentUser;
      if (!user) return;

      const userDoc = doc(db, "users", user.uid);
      await setDoc(userDoc, {
        name: nameInput.value,
        age: ageInput.value,
        bio: bioInput.value,
      }, { merge: true });

      if (profileImageInput.files.length > 0) {
        const file = profileImageInput.files[0];
        const storageRef = ref(storage, `users/${user.uid}/profile.jpg`);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        profileImage.src = url;
        await updateDoc(userDoc, { profileImageUrl: url });
      }

      alert('Profile updated!');
    }

    // Загрузка фото в галерею
    galleryInput.addEventListener('change', async () => {
      const user = auth.currentUser;
      if (!user) return;

      const files = galleryInput.files;
      for (let file of files) {
        const fileRef = ref(storage, `users/${user.uid}/gallery/${file.name}`);
        await uploadBytes(fileRef, file);
        const url = await getDownloadURL(fileRef);
        addImageToGallery(url);
      }
      galleryInput.value = ''; // Очистить input
    });

    // Загрузка галереи
    async function loadGallery(userId) {
      const galleryRef = ref(storage, `users/${userId}/gallery`);
      const gallerySnapshot = await galleryRef.listAll();
      for (let item of gallerySnapshot.items) {
        const url = await getDownloadURL(item);
        addImageToGallery(url);
      }
    }

    // Добавление изображения в DOM
    function addImageToGallery(url) {
      const img = document.createElement('img');
      img.src = url;
      gallery.appendChild(img);
    }
  </script>
</body>
</html>
